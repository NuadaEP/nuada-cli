import { Request, Response } from 'express';

import User from '../models/UserModel';
import AppError from '../errors/AppError';

export default class SessionController {
  public async store(request: Request, response: Response): Promise<Response> {
    const { email, password } = request.body;

    const user = await User.findOne({ email });

    if (!user) throw new AppError('User not found', 400);

    if (!(await user.compareHash(password)))
      throw new AppError('Invalid email password combination', 400);

    const userWithOutPassword = user.toJSON();

    delete userWithOutPassword.password;

    return response.json({ token: User.generateToken(userWithOutPassword) });
  }
}
